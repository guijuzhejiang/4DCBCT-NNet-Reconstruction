# 4DCBCT-NNet-Reconstruction 操作手册（中文版）

## 项目概述
本项目实现了基于深度学习的4D锥束CT（CBCT）医用图像重建系统，包含训练、推理和评估三个主要模块。

## 代码文件说明

### 1. 001_train.py - 模型训练脚本
**功能描述**：实现N-net深度学习模型的训练，包含数据加载、模型训练、验证和日志记录。

#### 主要特性
- 支持多种学习率调度器（StepLR、ReduceLROnPlateau、CosineAnnealingWarmRestarts等）
- 集成TensorBoard和Weights & Biases日志记录
- 使用MONAI库的专业医学图像损失函数
- 实现早期停止机制防止过拟合
- 支持多种数据增强技术

#### 使用方法
1. **配置参数**
   - 在 `config.py` 中设置训练参数
   - 确认数据路径、模型参数和训练配置

2. **运行训练**
   ```bash
   python 001_train.py
   ```

3. **输出文件**
   - 实验结果保存在 `experiments/Nnet/{FOV_TYPE}/{TIMESTAMP}/` 目录下
   - 包含最佳模型权重、配置文件备份、TensorBoard日志等

#### 关键配置项
- `TRAINING_CONFIG['epochs']`：训练轮数
- `TRAINING_CONFIG['train_batch_size']`：训练批次大小
- `SCHEDULER_CONFIG['type']`：学习率调度器类型
- `DATASET_CONFIG['data_root']`：数据根目录

### 2. 002_inference.py - 模型推理脚本
**功能描述**：使用训练好的模型对测试数据进行推理，生成修复后的图像并计算评估指标。

#### 主要特性
- 自动加载训练好的模型权重
- 计算多种图像质量评估指标（PSNR、SSIM、MS-SSIM、Corr2）
- 生成对比图像（Prior | Noisy | Restored | GT）
- 保存PNG格式和RAW格式的结果图像
- 生成统计报告和可视化图表

#### 使用方法
1. **设置模型路径**
   - 修改脚本中的 `OUTPUT_FOLDER` 变量，指向训练好的模型目录
   ```python
   OUTPUT_FOLDER = '/path/to/your/trained/model/folder'
   ```

2. **⚠️ 重要配置一致性检查**
   - 必须确保 `002_inference.py` 中的 `OUTPUT_FOLDER` 对应的FOV类型与 `config.py` 中的 `DATASET_CONFIG['test_fov_type']` 设置一致
   - **示例配置对应关系**：
     ```python
     # 如果 OUTPUT_FOLDER 指向 FovL 训练的模型：
     OUTPUT_FOLDER = '.../20251018_NNet_FovL_phase_00'
     # 则 config.py 中必须设置：
     DATASET_CONFIG['test_fov_type'] = 'FovL'
     
     # 如果 OUTPUT_FOLDER 指向 FovS_180 训练的模型：
     OUTPUT_FOLDER = '.../20251016_NNet_FovS180_phase_00'
     # 则 config.py 中必须设置：
     DATASET_CONFIG['test_fov_type'] = 'FovS_180'
     
     # 如果 OUTPUT_FOLDER 指向 FovS_360 训练的模型：
     OUTPUT_FOLDER = '.../20251017_NNet_FovS360_phase_00'
     # 则 config.py 中必须设置：
     DATASET_CONFIG['test_fov_type'] = 'FovS_360'
     ```
   - **错误配置会导致**：数据加载失败或模型与测试数据不匹配的错误

3. **运行推理**
   ```bash
   python 002_inference.py
   ```

4. **输出文件**
   - `inference_results/comparison_images/`：PNG格式对比图像
   - `inference_results/comparison_raw_images/`：RAW格式图像数据
   - `inference_results/evaluation_results/`：评估报告和统计图表

#### 关键指标说明
- **PSNR**：峰值信噪比，数值越高图像质量越好
- **SSIM**：结构相似性指数，范围0-1，越接近1越好
- **MS-SSIM**：多尺度结构相似性指数
- **Corr2**：相关系数，衡量图像间的线性相关性
- **MAE**：平均绝对误差，数值越小越好
- **RMSE**：均方根误差，数值越小越好

### 3. 101_evaluate_multi_infer_AllSubjects.py - 多模型对比评估脚本
**功能描述**：对多个推理结果进行横向比较评估，支持多个受试者的批量处理。

#### 主要特性
- 支持多个模型结果的同时比较
- 自动检测共同的受试者数据
- 生成线轮廓分析图表
- 创建小提琴图和散点图进行统计分析
- 支持ROI区域定量评估

#### 使用方法
1. **配置评估参数**
   - 修改脚本中的 `INFER_FOLDERS` 字典，添加要比较的模型结果路径
   ```python
   INFER_FOLDERS = {
       'model_1': '/path/to/model1/inference_results/comparison_raw_images',
       'model_2': '/path/to/model2/inference_results/comparison_raw_images',
       # 添加更多模型...
   }
   ```

2. **设置评估参数**
   - `IMG_NUM_RANGE`：评估的图像编号范围
   - `ROI`：定量评估的感兴趣区域
   - `LP_*`：线轮廓分析参数

3. **运行评估**
   ```bash
   python 101_evaluate_multi_infer_AllSubjects.py
   ```

4. **输出文件**
   - `VisualEvaluation/`：目视评估用的合并图像
   - `LineProfileEvaluation/`：线轮廓分析结果
   - `QuantitativeEvaluation/`：定量评估报告和统计图表

## 详细配置说明 (config.py)

系统的所有关键参数都在 `config.py` 文件中集中管理。以下是各配置模块的详细说明：

### TRAINING_CONFIG - 训练配置参数

```python
TRAINING_CONFIG = {
    'train_batch_size': 1,              # 训练批次大小，建议根据GPU内存调整（1-8）
    'val_batch_size': 48,               # 验证批次大小，可设置较大值以加速验证
    'num_workers': 1,                   # 数据加载进程数，建议设置为CPU核心数的1/2
    'epochs': 100,                      # 训练总轮数，通常设置50-200
    'model_save_dir': './trained_model', # 模型保存目录（相对路径）
    'weight_l1': 0.1,                   # L1损失权重，控制图像细节保持
    'weight_percep': 0.2,               # 感知损失权重，控制视觉质量
    'weight_ssim': 0.3,                 # SSIM损失权重，控制结构相似性
    'weight_mse': 0.4,                  # MSE损失权重，控制整体误差
    'seed': 42,                         # 随机种子，确保实验可重复性
    'early_stopping_patience': 3,       # 早期停止耐心值，验证损失不改善的轮数
}
```

### DATASET_CONFIG - 数据集配置参数

```python
DATASET_CONFIG = {
    'data_root': '/home/zzg/data/Medical/4D_Lung_CBCT_Hitachi/dataset/',  # 数据根目录绝对路径
    'train_fov_type': 'FovS_360',       # 训练数据FOV类型："FovL", "FovS_180", "FovS_360"
    'test_fov_type': 'FovS_360',        # 测试数据FOV类型
    'train_dataset_indices': list(range(0, 40)),    # 训练数据索引范围
    'val_dataset_indices': list(range(40, 45)),     # 验证数据索引范围
    'test_dataset_indices': list(range(45, 50)),    # 测试数据索引范围
    'image_size': (512, 512),           # 图像尺寸，固定为512x512
    'image_number': 384,                # 每个受试者的图像数量
}
```

#### 重要配置说明：
- **data_root**：必须设置为数据集的绝对路径
- **FOV类型**：
  - `FovL`：大视野（Large Field of View）
  - `FovS_180`：小视野180度
  - `FovS_360`：小视野360度
- **数据分割**：训练、验证、测试数据不应重叠，总和应覆盖所有可用数据

### MODEL_CONFIG - 模型配置参数

```python
MODEL_CONFIG = {
    'input_channels': 1,                # 输入通道数，医学CT图像通常为1
    'output_channels': 1,               # 输出通道数，重建图像为1
}
```

### LOGGING_CONFIG - 日志配置参数

```python
LOGGING_CONFIG = {
    'use_wandb': True,                  # 是否使用Weights & Biases在线日志
    'use_tensorboard': True,            # 是否使用TensorBoard本地日志
    'wandb_project': 'nnet-medical-ct', # W&B项目名称
    'wandb_entity': None,               # W&B用户名或团队名（可选）
}
```

#### 配置建议：
- **首次使用**：建议先设置 `use_tensorboard=True`, `use_wandb=False`
- **团队协作**：设置W&B相关参数，便于共享实验结果
- **离线环境**：设置 `use_wandb=False`，仅使用TensorBoard

### SCHEDULER_CONFIG - 学习率调度器配置

```python
SCHEDULER_CONFIG = {
    'type': 'ReduceLROnPlateau',        # 调度器类型
    'step_size': 1,                     # StepLR步长
    'gamma': 0.90,                      # 学习率衰减因子
    'lr': 1e-4,                         # 初始学习率（已弃用，使用max_lr）
    'min_lr': 1e-6,                     # 最小学习率
    'max_lr': 1e-4,                     # 最大学习率
    # ReduceLROnPlateau 特定参数
    'plateau_factor': 0.2,              # 验证损失停滞时的衰减因子
    'plateau_patience': 1,              # 等待验证损失改善的轮数
    'ReduceLR_min_lr': 1e-7,           # ReduceLROnPlateau的最小学习率
    # CosineAnnealingWarmRestarts 特定参数
    'T_0': 1,                          # 初始重启周期
    'T_mult': 2,                       # 周期乘数
    # OneCycleLR 特定参数
    'pct_start': 0.3,                  # 学习率上升阶段占比
    # CyclicLR 特定参数
    'epoch_size_up': 1,                # 半周期轮数
    'mode': 'triangular',              # 周期模式
}
```

#### 支持的调度器类型：
1. **ReduceLROnPlateau**：验证损失停滞时降低学习率（推荐）
2. **StepLR**：固定步长降低学习率
3. **CosineAnnealingWarmRestarts**：余弦退火+热重启
4. **CosineAnnealingLR**：余弦退火
5. **CyclicLR**：循环学习率
6. **OneCycleLR**：单周期学习率

#### 调度器选择建议：
- **小数据集**：推荐 `ReduceLROnPlateau`
- **大数据集**：推荐 `CosineAnnealingWarmRestarts`
- **快速收敛**：尝试 `CyclicLR`

### DEVICE_CONFIG - 硬件配置参数

```python
DEVICE_CONFIG = {
    'use_cuda': True,                   # 是否使用CUDA加速
    'cuda_device': 0,                   # CUDA设备ID（多GPU时指定）
}
```

#### 硬件配置说明：
- **单GPU**：保持默认设置
- **多GPU**：设置 `cuda_device` 为目标GPU ID
- **CPU训练**：设置 `use_cuda=False`（不推荐，训练极慢）

## 配置文件使用示例

### 基础配置（初学者推荐）
```python
# 小批次，保守设置
TRAINING_CONFIG = {
    'train_batch_size': 2,
    'val_batch_size': 16,
    'epochs': 50,
    'early_stopping_patience': 5,
}

SCHEDULER_CONFIG = {
    'type': 'ReduceLROnPlateau',
    'max_lr': 1e-4,
    'plateau_patience': 3,
}
```

### 高性能配置（适用于充足GPU内存）
```python
# 大批次，快速训练
TRAINING_CONFIG = {
    'train_batch_size': 8,
    'val_batch_size': 32,
    'num_workers': 1,
    'epochs': 100,
}

SCHEDULER_CONFIG = {
    'type': 'CosineAnnealingWarmRestarts',
    'max_lr': 1e-3,
    'T_0': 10,
}
```

### 调试配置（快速验证流程）
```python
# 小数据量，快速测试
DATASET_CONFIG = {
    'train_dataset_indices': [0, 1],
    'val_dataset_indices': [2],
    'test_dataset_indices': [3],
}

TRAINING_CONFIG = {
    'epochs': 5,
    'early_stopping_patience': 1,
}
```

## 完整工作流程

### 步骤1：环境准备
1. 安装依赖包：
   ```bash
   pip install torch torchvision monai numpy matplotlib pandas scikit-image pytorch-msssim wandb tensorboard seaborn tqdm
   ```

2. 检查数据集完整性：
   ```bash
   python check_data.py
   ```

### 步骤2：模型训练
1. 配置训练参数（`config.py`）
2. 运行训练脚本：
   ```bash
   python 001_train.py
   ```
3. 监控训练过程（TensorBoard或W&B）

### 步骤3：模型推理
1. 更新推理脚本中的模型路径
2. 运行推理：
   ```bash
   python 002_inference.py
   ```

### 步骤4：多模型比较评估
1. 配置多个模型的结果路径
2. 运行评估脚本：
   ```bash
   python 101_evaluate_multi_infer_AllSubjects.py
   ```

## 注意事项

1. **内存管理**：训练和推理过程中会占用大量GPU内存，建议使用GPU内存>=8GB
2. **数据格式**：输入数据应为512x512的16位有符号整数RAW格式
3. **路径配置**：确保所有路径使用绝对路径，避免相对路径导致的错误
4. **模型兼容性**：推理时使用的模型必须与训练时的架构完全一致

## 故障排除

### 常见问题
1. **内存不足**：减小批次大小
2. **CUDA错误**：检查CUDA版本与PyTorch版本的兼容性
3. **数据加载失败**：验证数据路径和文件权限
4. **模型加载失败**：确认模型文件完整性和路径正确性

### 日志查看
- TensorBoard：`tensorboard --logdir experiments/`
- 控制台输出：包含详细的训练进度和错误信息
- 实验配置：保存在实验目录的 `configs/` 文件夹中

## 数据结构要求

### 输入数据格式
- **图像尺寸**：512 × 512 像素
- **数据类型**：16位有符号整数（int16）
- **文件扩展名**：`.img`（RAW二进制格式）

### 数据预处理要求
- **归一化**：数据在训练前会自动归一化到[0,1]范围
- **内存格式**：使用PyTorch张量格式，支持GPU加速
- **批处理**：支持批量处理，批次大小可在config.py中配置

## 评价指标详细

### 图像质量指标
- **PSNR（峰值信噪比）**
  - 计算公式：20 * log10(MAX_VALUE / sqrt(MSE))
  - 典型良好值：> 30 dB
  - 用途：衡量图像重建的整体质量

- **SSIM（结构相似性指数）**
  - 计算公式：亮度、对比度、结构的综合评估
  - 范围：0-1（1为完全匹配）
  - 用途：评估图像结构保持程度

- **MS-SSIM（多尺度SSIM）**
  - 在多个分辨率级别计算SSIM
  - 更接近人类视觉感知
  - 对图像细节更敏感

- **Corr2（相关系数）**
  - 皮尔逊相关系数
  - 范围：-1 到 1（1为完全正相关）
  - 用途：衡量图像间的线性相关性

- **MAE（平均绝对误差）**
  - 计算公式：mean(|predicted - ground_truth|)
  - 单位：与图像像素值相同
  - 用途：衡量逐像素预测精度

- **RMSE（均方根误差）**
  - 计算公式：sqrt(mean((predicted - ground_truth)²))
  - 单位：与图像像素值相同
  - 用途：对大误差更敏感的整体误差度量

### 评估阈值参考
- **优秀水平**：PSNR > 35 dB, SSIM > 0.95, Corr2 > 0.98
- **良好水平**：PSNR > 30 dB, SSIM > 0.90, Corr2 > 0.95
- **可接受水平**：PSNR > 25 dB, SSIM > 0.85, Corr2 > 0.90